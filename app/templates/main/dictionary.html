{% extends "main/base_layout.html" %}

{% block title %}词库管理，ymk版本{% endblock %}

{% block styles %}
<style>
    /* 重写容器样式 */
.container {
    margin-left: 17vw !important;
    width: 83vw !important;
    background-color: #f8f9fa;
    color: rgb(110,111,114);
    line-height: 1.6;
    padding: 1.4vw;
    min-height: 100vh;
    box-sizing: border-box;
}

/* 页面标题 */
h1 {
    font-size: 2rem;
    font-weight: 600;
    color: rgb(0,148,217);
    margin-bottom: 2.1vw;
    display: flex;
    align-items: center;
    gap: 0.7vw;
}

h2 {
    font-size: 1.4rem;
    font-weight: 600;
    color: rgb(0,148,217);
    margin-bottom: 1.4vw;
}

/* 统计信息区域 */
.stats-section {
    background: white;
    border-radius: 0.8vw;
    padding: 1.8vw;
    margin-bottom: 2.1vw;
    display: flex;
    align-items: center;
    gap: 2.8vw;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.stats-item {
    display: flex;
    flex-direction: column;
}

.stats-value {
    font-size: 2rem;
    font-weight: 700;
    color: rgb(0,148,217);
    margin-bottom: 0.4vw;
}

.stats-label {
    font-size: 1rem;
    color: rgb(110,111,114);
}

/* 停翻词管理 */
.stop-words-section {
    background: white;
    border-radius: 0.8vw;
    padding: 1.8vw;
    margin-bottom: 2.1vw;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.stop-words-input-group {
    display: flex;
    gap: 0.7vw;
    margin-bottom: 1.4vw;
}

.stop-words-input-group input {
    flex: 1;
    padding: 0.8vw 1.2vw;
    border: 1px solid #dee2e6;
    border-radius: 0.4vw;
    font-size: 1rem;
    transition: all 0.2s ease;
}

.stop-words-input-group input:focus {
    outline: none;
    border-color: rgb(0,148,217);
    box-shadow: 0 0 0 0.2vw rgba(0,148,217,0.2);
}

.stop-words-input-group button {
    padding: 0.8vw 1.4vw;
    background: rgb(0,148,217);
    color: white;
    border: none;
    border-radius: 0.4vw;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.4vw;
    transition: all 0.2s ease;
    font-size: 1rem;
}

.stop-words-input-group button:hover {
    background: rgb(0,120,180);
}

.stop-words-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.7vw;
}

.stop-word-item {
    display: flex;
    align-items: center;
    background: #e9ecef;
    border-radius: 1rem;
    padding: 0.4vw 0.8vw;
    font-size: 0.9rem;
}

.stop-word-item span {
    margin-right: 0.4vw;
}

/* 添加翻译 */
.add-section {
    background: white;
    border-radius: 0.8vw;
    padding: 1.8vw;
    margin-bottom: 2.1vw;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.input-group {
    display: flex;
    gap: 0.7vw;
    margin-bottom: 1.4vw;
    flex-wrap: wrap;
}

.input-group input {
    flex: 1;
    min-width: 120px;
    padding: 0.8vw 1.2vw;
    border: 1px solid #dee2e6;
    border-radius: 0.4vw;
    font-size: 1rem;
    transition: all 0.2s ease;
}

.input-group input:focus {
    outline: none;
    border-color: rgb(0,148,217);
    box-shadow: 0 0 0 0.2vw rgba(0,148,217,0.2);
}

.input-group button {
    padding: 0.8vw 1.4vw;
    background: rgb(0,148,217);
    color: white;
    border: none;
    border-radius: 0.4vw;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.4vw;
    transition: all 0.2s ease;
    font-size: 1rem;
}

.input-group button:hover {
    background: rgb(0,120,180);
}

/* 搜索栏 */
.search-section {
    background: white;
    border-radius: 0.8vw;
    padding: 1.8vw;
    margin-bottom: 2.1vw;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.search-container {
    display: flex;
    gap: 0.7vw;
}

.search-container input {
    flex: 1;
    padding: 0.8vw 1.2vw;
    border: 1px solid #dee2e6;
    border-radius: 0.4vw;
    font-size: 1rem;
    transition: all 0.2s ease;
}

.search-container input:focus {
    outline: none;
    border-color: rgb(0,148,217);
    box-shadow: 0 0 0 0.2vw rgba(0,148,217,0.2);
}

.search-container button {
    padding: 0.8vw 1.4vw;
    background: rgb(0,148,217);
    color: white;
    border: none;
    border-radius: 0.4vw;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.4vw;
    transition: all 0.2s ease;
    font-size: 1rem;
}

.search-container button:hover {
    background: rgb(0,120,180);
}

/* 词库表格 */
.table-section {
    background: white;
    border-radius: 0.8vw;
    padding: 1.8vw;
    margin-bottom: 2.1vw;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.table-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.4vw;
    flex-wrap: wrap;
    gap: 1vw;
}

.view-toggle {
    display: flex;
    background: #e9ecef;
    border-radius: 0.4vw;
    overflow: hidden;
}

.view-toggle button {
    padding: 0.5vw 1vw;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.view-toggle button.active {
    background: rgb(0,148,217);
    color: white;
}

.view-toggle button:not(.active):hover {
    background: #dee2e6;
}

.table-wrapper {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

th, td {
    padding: 0.8vw 1vw;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
    position: sticky;
    top: 0;
}

tr:hover {
    background: #f8f9fa;
}

.action-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.4vw;
    border-radius: 0.3vw;
    color: rgb(110,111,114);
    transition: all 0.2s ease;
    font-size: 1rem;
}

.action-btn:hover {
    color: rgb(0,148,217);
    background: rgba(0,148,217,0.1);
}

/* 分页 */
.pagination {
    display: flex;
    justify-content: center;
    gap: 0.5vw;
    margin-top: 1.4vw;
}

.pagination button {
    padding: 0.6vw 1.2vw;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.4vw;
    color: rgb(110,111,114);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 1rem;
}

.pagination button:hover {
    background: rgba(0,148,217,0.1);
    border-color: rgb(0,148,217);
    color: rgb(0,148,217);
}

.pagination button.active {
    background: rgb(0,148,217);
    color: white;
    border-color: rgb(0,148,217);
}

/* 空状态 */
.empty-state {
    text-align: center;
    padding: 2.8vw;
    color: rgb(110,111,114);
}

.empty-state i {
    font-size: 3rem;
    color: rgba(0,148,217,0.5);
    margin-bottom: 1.4vw;
}
</style>
{% endblock %}

{% block content %}
<h1><i class="bi bi-book"></i> 我的词库</h1>

<script>
// 在JavaScript中定义当前用户ID，避免在模板字符串中使用Jinja2语法
const CURRENT_USER_ID = {{ current_user.id }};
</script>

<!-- 统计信息 -->
<section class="stats-section">
    <div class="stats-item">
        <div class="stats-value" id="totalTranslations">0</div>
        <div class="stats-label">词条总数</div>
    </div>
    <div class="stats-item">
        <div class="stats-value" id="totalStopWords">0</div>
        <div class="stats-label">停翻词数量</div>
    </div>
</section>

<!-- 添加停翻词 -->
<section class="stop-words-section">
    <h2>停翻词管理</h2>
    <div class="stop-words-input-group">
        <input type="text" id="stopWordInput" placeholder="输入要添加的停翻词">
        <button id="addStopWordBtn">
            <i class="bi bi-plus-lg"></i>
            添加
        </button>
    </div>
    <div id="stopWordsList" class="stop-words-list">
        <!-- 停翻词列表将通过JavaScript动态插入 -->
    </div>
</section>
<!-- 添加新翻译 -->
<section class="add-section">
    <h2>添加新翻译</h2>
    <div class="input-group">
        <input type="text" id="englishInput" placeholder="英文">
        <input type="text" id="chineseInput" placeholder="中文">
        <input type="text" id="dutchInput" placeholder="荷兰语">
        <input type="text" id="categoryInput" placeholder="分类（多个分类用分号分隔）">
        <button id="addBtn">
            <i class="bi bi-plus-lg"></i>
            添加
        </button>
    </div>
    {% if current_user.is_administrator() %}
    <div class="input-group">
        <label>
            <input type="checkbox" id="isPublicCheckbox"> 
            设为公共词条（所有用户可见）
        </label>
    </div>
    {% endif %}
</section>
<!-- 搜索栏 -->
<section class="search-section">
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="搜索英文、中文、荷兰语、分类等...">
        <button id="searchBtn">
            <i class="bi bi-search"></i>
            搜索
        </button>
    </div>
</section>

<!-- 词库表格 -->
<section class="table-section">
    <div class="table-controls">
        <div class="view-toggle">
            <button class="active" data-view="private">我的词条</button>
            <button data-view="public">公共词条</button>
            <button data-view="all">所有词条</button>
        </div>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>英文</th>
                    <th>中文</th>
                    <th>荷兰语</th>
                    <th>分类</th>
                    <th>创建时间</th>
                    <th>类型</th>
                    <th>创建者</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="translationTable">
                <!-- 数据将通过JavaScript动态插入 -->
            </tbody>
        </table>
    </div>
    <div id="emptyState" class="empty-state" style="display: none;">
        <i class="bi bi-book"></i>
        <p>暂无数据</p>
    </div>
    <div class="pagination" id="pagination">
        <!-- 分页将通过JavaScript动态插入 -->
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// 当前页面和搜索词
let currentPage = 1;
let currentSearch = '';
let currentView = 'private'; // private, public, all

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadTranslations();
    loadStopWords();
    updateStats();
    
    // 绑定事件
    document.getElementById('addBtn').addEventListener('click', addTranslation);
    document.getElementById('addStopWordBtn').addEventListener('click', addStopWord);
    document.getElementById('searchBtn').addEventListener('click', () => {
        currentPage = 1;
        loadTranslations(document.getElementById('searchInput').value.trim());
    });
    
    // 回车搜索
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            currentPage = 1;
            loadTranslations(this.value.trim());
        }
    });
    
    // 视图切换
    const viewButtons = document.querySelectorAll('.view-toggle button');
    viewButtons.forEach((button, index) => {
        button.addEventListener('click', function() {
            viewButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            this.classList.add('active');
            currentView = this.dataset.view;
            currentPage = 1;
            // 保留搜索框内容并重新加载数据
            currentSearch = document.getElementById('searchInput').value.trim();
            loadTranslations(currentSearch, currentPage);
        });
    });
});

// 更新统计信息
async function updateStats() {
    try {
        const response = await fetch('/api/translations/stats');
        const data = await response.json();
        
        document.getElementById('totalTranslations').textContent = data.total_translations || 0;
    } catch (error) {
        console.error('获取统计信息失败:', error);
    }
    
    try {
        const response = await fetch('/api/stop-words/stats');
        const data = await response.json();
        
        document.getElementById('totalStopWords').textContent = data.total_stop_words || 0;
    } catch (error) {
        console.error('获取停翻词统计失败:', error);
    }
}

// 添加翻译
async function addTranslation() {
    const english = document.getElementById('englishInput').value.trim();
    const chinese = document.getElementById('chineseInput').value.trim();
    const dutch = document.getElementById('dutchInput').value.trim();
    const category = document.getElementById('categoryInput').value.trim();
    const isPublic = document.getElementById('isPublicCheckbox')?.checked || false;
    
    if (!english || !chinese) {
        showToast('英文和中文为必填项', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/translations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                english, 
                chinese, 
                dutch, 
                category,
                is_public: isPublic
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('添加成功', 'success');
            document.getElementById('englishInput').value = '';
            document.getElementById('chineseInput').value = '';
            document.getElementById('dutchInput').value = '';
            document.getElementById('categoryInput').value = '';
            if (document.getElementById('isPublicCheckbox')) {
                document.getElementById('isPublicCheckbox').checked = false;
            }
            loadTranslations(currentSearch, currentPage);
            updateStats();
        } else {
            throw new Error(result.error || '添加失败');
        }
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// 添加停翻词
async function addStopWord() {
    const word = document.getElementById('stopWordInput').value.trim();
    
    if (!word) {
        showToast('请输入停翻词', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/stop-words', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ word })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('添加成功', 'success');
            document.getElementById('stopWordInput').value = '';
            loadStopWords();
            updateStats();
        } else {
            throw new Error(result.error || '添加失败');
        }
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// 加载翻译数据
async function loadTranslations(searchTerm = '', page = 1) {
    currentSearch = searchTerm;
    currentPage = page;
    
    try {
        const response = await fetch(`/api/translations?search=${searchTerm}&page=${page}&visibility=${currentView}`);
        
        // 检查响应是否为JSON格式
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error('服务器返回了非JSON响应: ' + text.substring(0, 100));
        }
        
        const data = await response.json();
        
        const tbody = document.getElementById('translationTable');
        const emptyState = document.getElementById('emptyState');
        
        if (data.translations.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
        } else {
            emptyState.style.display = 'none';
            
            tbody.innerHTML = data.translations.map(item => `
                <tr>
                    <td>${item.english}</td>
                    <td>${item.chinese}</td>
                    <td>${item.dutch || ''}</td>
                    <td>${item.category || ''}</td>
                    <td>${new Date(item.created_at).toLocaleString()}</td>
                    <td>${item.is_public ? '<span style="color: #007bff;">公共</span>' : '私人'}</td>
                    <td>${item.is_public && item.user ? item.user.username : (item.user_id == CURRENT_USER_ID ? '我' : '')}</td>
                    <td>
                        <button class="action-btn" onclick="editTranslation(${item.id})" title="编辑">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="action-btn" onclick="deleteTranslation(${item.id})" title="删除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // 更新分页
        updatePagination(data.total_pages, page);
        
    } catch (error) {
        console.error('加载数据失败:', error);
        showToast('加载数据失败: ' + error.message, 'error');
    }
}

// 加载停翻词列表
async function loadStopWords() {
    try {
        const response = await fetch('/api/stop-words');
        const data = await response.json();
        
        const stopWordsList = document.getElementById('stopWordsList');
        
        if (data.stop_words.length === 0) {
            stopWordsList.innerHTML = '<div class="empty-state">暂无停翻词</div>';
        } else {
            stopWordsList.innerHTML = data.stop_words.map(item => `
                <div class="stop-word-item">
                    <span>${item.word}</span>
                    <button class="action-btn" onclick="deleteStopWord(${item.id})" title="删除">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join('');
        }
    } catch (error) {
        showToast('加载停翻词失败', 'error');
    }
}

// 编辑翻译
async function editTranslation(id) {
    // 先获取当前翻译的信息
    const response = await fetch(`/api/translations`);
    const data = await response.json();
    
    const translation = data.translations.find(t => t.id === id);
    if (!translation) {
        showToast('未找到该翻译', 'error');
        return;
    }
    
    // 显示编辑对话框
    const newEnglish = prompt('英文:', translation.english);
    if (newEnglish === null) return; // 用户取消
    
    const newChinese = prompt('中文:', translation.chinese);
    if (newChinese === null) return; // 用户取消
    
    const newDutch = prompt('荷兰语:', translation.dutch || '');
    const newCategory = prompt('分类:', translation.category || '');
    
    if (!newEnglish || !newChinese) {
        showToast('英文和中文为必填项', 'error');
        return;
    }
    
    try {
        const updateResponse = await fetch(`/api/translations/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                english: newEnglish,
                chinese: newChinese,
                dutch: newDutch,
                category: newCategory
            })
        });
        
        const result = await updateResponse.json();
        
        if (updateResponse.ok) {
            showToast('更新成功', 'success');
            loadTranslations(currentSearch, currentPage);
            updateStats();
        } else {
            throw new Error(result.error || '更新失败');
        }
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// 删除翻译
async function deleteTranslation(id) {
    if (!confirm('确定要删除这个翻译吗？')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/translations/${id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('删除成功', 'success');
            loadTranslations(currentSearch, currentPage);
            updateStats();
        } else {
            throw new Error(result.error || '删除失败');
        }
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// 删除停翻词
async function deleteStopWord(id) {
    if (!confirm('确定要删除这个停翻词吗？')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/stop-words/${id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('删除成功', 'success');
            loadStopWords();
            updateStats();
        } else {
            throw new Error(result.error || '删除失败');
        }
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// 更新分页
function updatePagination(totalPages, currentPage) {
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // 上一页
    if (currentPage > 1) {
        html += `<button onclick="loadTranslations('${currentSearch}', ${currentPage - 1})">&laquo;</button>`;
    }
    
    // 页码
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            html += `<button class="active">${i}</button>`;
        } else {
            html += `<button onclick="loadTranslations('${currentSearch}', ${i})">${i}</button>`;
        }
    }
    
    // 下一页
    if (currentPage < totalPages) {
        html += `<button onclick="loadTranslations('${currentSearch}', ${currentPage + 1})">&raquo;</button>`;
    }
    
    pagination.innerHTML = html;
}

// 显示提示信息
function showToast(message, type) {
    // 创建提示元素
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    // 根据类型设置样式
    if (type === 'success') {
        toast.style.backgroundColor = '#28a745';
    } else {
        toast.style.backgroundColor = '#dc3545';
    }
    
    toast.textContent = message;
    
    // 添加到页面
    document.body.appendChild(toast);
    
    // 显示动画
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
    }, 100);
    
    // 3秒后移除
    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}
</script>
{% endblock %}