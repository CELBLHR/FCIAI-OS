{% extends "main/base_layout.html" %}

{% block title %}{% if session.get('language') == 'en' %}PDF Translation{% else %}PDF翻译{% endif %}{% endblock %}

{% block styles %}
<style>
    .container { margin-left: 17vw !important; width: 83vw !important; background-color: #f8f9fa; color: rgb(110,111,114); line-height: 1.6; padding: 1.4vw; min-height: 100vh; box-sizing: border-box; }
    .page-header { display: flex; align-items: center; margin-bottom: 2.1vw; background: white; padding: 1.4vw 2.1vw; border-radius: 0.8vw; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .header-icon { width: 2.8vw; height: 2.8vw; min-width: 32px; min-height: 32px; background: rgb(220,53,69); border-radius: 0.6vw; display: flex; align-items: center; justify-content: center; margin-right: 1vw; }
    .header-icon i { color: white; font-size: 1.4rem; }
    .header-title { font-size: 2rem; font-weight: 600; color: rgb(0,148,217); }
    .main-content { display: grid; grid-template-columns: 15vw 1fr; gap: 1.5vw; align-items: start; width: 100%; max-width: none; }
    .config-panel { background: white; border-radius: 0.8vw; padding: 1.0vw; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: sticky; top: 1.4vw; }
    .config-panel h3 { font-size: 1.2rem; font-weight: 600; color: rgb(0,148,217); margin-bottom: 1.0vw; display: flex; align-items: center; gap: 0.6vw; }
    .form-group { margin-bottom: 0.8vw; }
    .form-group label { display: block; margin-bottom: 0.3vw; font-size: 0.9rem; font-weight: 500; color: rgb(110,111,114); }
    .form-control { width: 100%; padding: 0.6vw 0.8vw; border: 1px solid #dee2e6; border-radius: 0.5vw; font-size: 0.9rem; color: rgb(110,111,114); background: white; transition: all 0.2s ease; }
    .form-control:focus { outline: none; border-color: rgb(0,148,217); box-shadow: 0 0 0 3px rgba(0,148,217,0.1); }
    .translation-area { display: flex; flex-direction: column; gap: 25px; }
    .upload-card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .upload-card h2 { font-size: 20px; font-weight: 600; color: rgb(0,148,217); margin-bottom: 25px; }
    .upload-zone { border: 2px dashed #dee2e6; border-radius: 12px; padding: 60px 30px; text-align: center; transition: all 0.3s ease; cursor: pointer; background: #fafbfc; }
    .upload-zone.dragover { border-color: rgb(0,148,217); background: rgba(0,148,217,0.02); }
    .upload-zone-content { display: flex; flex-direction: column; align-items: center; gap: 20px; }
    .upload-text { font-size: 16px; color: rgb(110,111,114); }
    .upload-btn { background: rgb(0,148,217); color: white; padding: 12px 30px; border-radius: 25px; font-size: 14px; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s ease; }
    .upload-btn:hover { background: rgb(0,130,190); transform: translateY(-1px); }
    .progress-container { margin-top: 25px; padding: 25px; background: #f8f9fa; border-radius: 12px; display: none; }
    .progress-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .progress-bar-container { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: rgb(0,148,217); width: 0; transition: width 0.3s ease; }
    .pdf-preview-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: none; }
    .pdf-viewer { width: 100%; height: 70vh; border: 1px solid #e9ecef; border-radius: 8px; }
    @media (max-width: 1200px) { .container { margin-left: 16vw !important; width: 84vw !important; } .main-content { grid-template-columns: 15vw 1fr; gap: 1.5vw; } }
    @media (max-width: 768px) { .container { margin-left: 15vw !important; width: 85vw !important; } .main-content { grid-template-columns: 1fr; gap: 1.4vw; } .config-panel { position: static; } }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-icon"><i class="bi bi-file-pdf"></i></div>
    <h1 class="header-title">{% if session.get('language') == 'en' %}PDF File Translation Tool{% else %}PDF文件翻译工具{% endif %}</h1>
</div>

<div class="main-content">
    <div class="config-panel">
        <h3><i class="bi bi-gear"></i> {% if session.get('language') == 'en' %}Translation Settings{% else %}翻译设置{% endif %}</h3>

        <div class="form-group">
            <label for="pdf-source-language">{% if session.get('language') == 'en' %}Source Language{% else %}源语言{% endif %}</label>
            <select id="pdf-source-language" class="form-control">
                <option value="English">{% if session.get('language') == 'en' %}English{% else %}英语{% endif %}</option>
                <option value="Chinese">{% if session.get('language') == 'en' %}Chinese{% else %}中文{% endif %}</option>
                <option value="Dutch">{% if session.get('language') == 'en' %}Dutch{% else %}荷兰语{% endif %}</option>
            </select>
        </div>

        <div class="form-group">
            <label for="pdf-target-language">{% if session.get('language') == 'en' %}Target Language{% else %}目标语言{% endif %}</label>
            <select id="pdf-target-language" class="form-control">
                <option value="Chinese">{% if session.get('language') == 'en' %}Chinese{% else %}中文{% endif %}</option>
                <option value="English">{% if session.get('language') == 'en' %}English{% else %}英语{% endif %}</option>
                <option value="Dutch">{% if session.get('language') == 'en' %}Dutch{% else %}荷兰语{% endif %}</option>
            </select>
        </div>

        <div class="form-group">
            <label for="pdf-bilingual">{% if session.get('language') == 'en' %}Language display{% else %}语言展示方式{% endif %}</label>
            <select id="pdf-bilingual" class="form-control">
                <option value="translation_only">{% if session.get('language') == 'en' %}Keep translated content only{% else %}只保留翻译内容{% endif %}</option>
                <option value="paragraph_up">{% if session.get('language') == 'en' %}Keep both source and translated content(source on top){% else %}保留源语言和翻译内容（源语言在上）{% endif %}</option>
                <option value="paragraph_down">{% if session.get('language') == 'en' %}Keep both source and translated content(translation on top){% else %}保留源语言和翻译内容（译文在上）{% endif %}</option>
            </select>
        </div>

        <div class="form-group">
            <label for="pdf-model">{% if session.get('language') == 'en' %}Translation Model{% else %}翻译模型{% endif %}</label>
            <select id="pdf-model" class="form-control">
                <option value="qwen">Qwen2.5</option>
                <option value="deepseek">DeepSeek-Chat</option>
                <option value="gpt4o">ChatGPT-4o</option>
            </select>
        </div>
    </div>

    <div class="translation-area">
        <div class="upload-card">
            <h2>{% if session.get('language') == 'en' %}PDF Translation{% else %}PDF翻译{% endif %}</h2>
            <div class="upload-zone" id="pdfDropZone" onclick="document.getElementById('pdfFileInput').click()">
                <div class="upload-zone-content">
                    <div class="upload-text">{% if session.get('language') == 'en' %}Drag PDF file here or click to upload{% else %}拖拽PDF文件到这里或点击上传{% endif %}</div>
                    <button class="upload-btn">
                        <i class="bi bi-upload"></i>
                        {% if session.get('language') == 'en' %}Upload PDF File{% else %}上传 PDF文件{% endif %}
                    </button>
                </div>
                <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;">
            </div>

            <div id="pdfProgressContainer" class="progress-container">
                <div class="progress-info">
                    <div>{% if session.get('language') == 'en' %}Uploading & processing...{% else %}正在上传与处理...{% endif %}</div>
                    <div class="progress-percentage"><span id="pdfProgressText">0%</span></div>
                </div>
                <div class="progress-bar-container"><div id="pdfProgressBarFill" class="progress-bar-fill"></div></div>
            </div>
        </div>

        <div id="pdfPreviewCard" class="pdf-preview-card">
            <h3 style="margin-top:0; color: rgb(0,148,217); font-size: 1.1rem;">{% if session.get('language') == 'en' %}Preview{% else %}预览{% endif %}</h3>
            <iframe id="pdfViewer" class="pdf-viewer"></iframe>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const pdfDropZone = document.getElementById('pdfDropZone');
    const pdfFileInput = document.getElementById('pdfFileInput');
    const pdfProgress = document.getElementById('pdfProgressContainer');
    const pdfProgressFill = document.getElementById('pdfProgressBarFill');
    const pdfProgressText = document.getElementById('pdfProgressText');
    const pdfPreviewCard = document.getElementById('pdfPreviewCard');
    const pdfViewer = document.getElementById('pdfViewer');

    // 拖拽交互
    pdfDropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); pdfDropZone.classList.add('dragover'); });
    pdfDropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); pdfDropZone.classList.remove('dragover'); });
    pdfDropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); pdfDropZone.classList.remove('dragover'); const files = e.dataTransfer.files; if (files.length > 0) { handlePdfFile(files[0]); } });
    pdfFileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { handlePdfFile(e.target.files[0]); } });

    function updatePdfProgress(percent) { pdfProgress.style.display = 'block'; pdfProgressFill.style.width = percent + '%'; pdfProgressText.textContent = percent + '%'; }

    async function handlePdfFile(file) {
        if (!file.name.match(/\.pdf$/i)) {
            showToast('{{ session.get("language", "zh") }}' === 'en' ? 'Please select a PDF file (.pdf)' : '请选择PDF文件(.pdf)', 'error');
            return;
        }

        try {
            updatePdfProgress(10);

            const formData = new FormData();
            formData.append('file', file);

            // 直接复用后端已有的PDF上传接口，返回可访问URL
            const response = await fetch('{{ url_for('main.upload_pdf') }}', { method: 'POST', body: formData });
            if (!response.ok) {
                throw new Error('Upload failed');
            }
            updatePdfProgress(60);

            const data = await response.json();
            // 显示PDF预览
            if (data.file_url) {
                pdfViewer.src = data.file_url;
                pdfPreviewCard.style.display = 'block';
            }
            updatePdfProgress(100);

            // 这里预留后续“开始翻译PDF”的入口（若后端提供接口，可在此发起翻译并显示进度）
            // TODO: startPdfTranslation(data.file_path, additionalParams)

            showToast('{{ session.get("language", "zh") }}' === 'en' ? 'File uploaded successfully' : '文件上传成功', 'success');
        } catch (e) {
            console.error(e);
            showToast('{{ session.get("language", "zh") }}' === 'en' ? 'Upload failed' : '上传失败', 'error');
            pdfProgress.style.display = 'none';
        }
    }
</script>
{% endblock %}

