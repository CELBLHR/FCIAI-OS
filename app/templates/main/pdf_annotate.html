{% extends "main/base_layout.html" %}

{% block title %}PDFæ³¨é‡Š{% endblock %}

{% block styles %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.css" rel="stylesheet">
<style>
.pdf-container {
    display: flex;
    gap: 20px;
    padding: 20px;
    height: calc(100vh - 100px);
}

.pdf-viewer {
    flex: 1;
    position: relative;
    background: transparent;
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.upload-area {
    padding: 20px;
    text-align: center;
    border: 2px dashed #ccc;
    border-radius: 8px;
    margin: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-area:hover {
    border-color: var(--primary-color);
    background: #f8f9fa;
}

.upload-area.drag-over {
    border-color: var(--primary-color);
    background: #e3f2fd;
}

.upload-area i {
    font-size: 48px;
    color: #666;
    margin-bottom: 10px;
}

.upload-area p {
    margin: 0;
    color: #666;
}

.upload-area input[type="file"] {
    display: none;
}

#canvas-container {
    background: transparent;
    position: relative;
    width: 100%;
    height: 100%;
    min-height: 70vh; /* ç¡®ä¿æœ‰è¶³å¤Ÿçš„é«˜åº¦ */
    overflow: auto;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.canvas-wrapper {
    position: relative;
    display: inline-block;
    width: auto;
    height: auto;
    max-width: calc(100vw - 320px); /* å‡å»ä¾§è¾¹æ å’Œå·¥å…·æ å®½åº¦ */
    max-height: calc(100vh - 200px); /* å‡å»å¤´éƒ¨å’Œåº•éƒ¨ç©ºé—´ */
    /* ç¡®ä¿å†…å®¹å®Œæ•´æ˜¾ç¤º */
    overflow: visible;
    margin: auto;
    /* æ·»åŠ è¾¹æ¡†ä»¥ä¾¿è°ƒè¯• */
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

#pdf-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* ä¼˜åŒ–é«˜åˆ†è¾¨ç‡æ˜¾ç¤º */
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    image-rendering: pixelated;
    /* ç¡®ä¿é«˜è´¨é‡ç¼©æ”¾ */
    transform-origin: top left;
}

#fabric-canvas {
    position: absolute !important;
    top: 0;
    left: 0;
    width: 100% !important;
    height: 100% !important;
    pointer-events: all !important;
}

.toolbar {
    position: fixed;
    top: 80px;
    right: 20px;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.tool-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    background: var(--primary-color);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tool-btn:hover {
    background: #0091ea;
}

.tool-btn.active {
    background: #0277bd;
}

.annotations-list {
    width: 250px;
    background: white;
    border-radius: 8px;
    padding: 15px;
    overflow-y: auto;
}

.annotation-item {
    padding: 10px;
    border: 1px solid #eee;
    border-radius: 4px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.annotation-item:hover {
    background: #f5f5f5;
}

.annotation-text {
    font-size: 0.9rem;
    color: #333;
    margin-bottom: 5px;
}

.annotation-page {
    font-size: 0.8rem;
    color: #666;
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* OCRçŠ¶æ€æ ·å¼ */
.status-text {
    margin: 10px 0;
    padding: 12px 16px;
    background-color: #ffffff;
    border: 2px solid #2196F3;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    color: #1a1a1a !important; /* æ·±é»‘è‰²ï¼Œç¡®ä¿é«˜å¯¹æ¯”åº¦ */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-shadow: none;
}

/* æ³¨é‡Šåˆ—è¡¨æ ·å¼ */
.annotation-item {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 10px;
    transition: background-color 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.annotation-item:hover {
    background-color: #f5f5f5;
}

.annotation-content {
    flex: 1;
    cursor: pointer;
}

.annotation-actions {
    display: flex;
    gap: 5px;
    margin-left: 10px;
}

.btn-edit, .btn-delete {
    background: none;
    border: none;
    font-size: 16px;
    cursor: pointer;
    padding: 5px;
    border-radius: 3px;
    transition: background-color 0.2s;
}

.btn-edit:hover {
    background-color: #e3f2fd;
}

.btn-delete:hover {
    background-color: #ffebee;
}
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1><i class="bi bi-file-pdf"></i> PDFæ³¨é‡Šå·¥å…·</h1>
    <div style="display: flex; gap: 1rem;">
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary" style="text-decoration: none; padding: 0.5rem 1rem; border-radius: 5px; background: rgba(0, 168, 255, 0.2); color: var(--text-color); border: 1px solid var(--primary-color); transition: all 0.3s ease;">
            <i class="bi bi-translate"></i> PPTç¿»è¯‘å·¥å…·
        </a>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-outline" style="text-decoration: none; padding: 0.5rem 1rem; border-radius: 5px; background: rgba(255, 0, 0, 0.1); color: #ff6b6b; border: 1px solid #ff6b6b; transition: all 0.3s ease;">
            <i class="bi bi-box-arrow-right"></i> é€€å‡ºç™»å½•
        </a>
    </div>
</div>

<div class="pdf-container">
    <div class="pdf-viewer">
        <div id="upload-area" class="upload-area">
            <input type="file" id="pdf-upload" accept=".pdf">
            <i class="bi bi-cloud-upload"></i>
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
        </div>
        <div id="canvas-container" style="display: none;">
            <div class="canvas-wrapper">
                <canvas id="pdf-canvas"></canvas>
                <canvas id="fabric-canvas"></canvas>
            </div>
        </div>
        <div class="loading-overlay" style="display: none;">
            <div class="spinner"></div>
        </div>
    </div>

    <div class="toolbar">
        <button class="tool-btn" id="rectangle-tool">
            <i class="bi bi-square"></i> çŸ©å½¢æ ‡æ³¨
        </button>
        <button class="tool-btn" id="select-tool">
            <i class="bi bi-cursor"></i> é€‰æ‹©
        </button>
        <button class="tool-btn" id="prev-page">
            <i class="bi bi-chevron-left"></i> ä¸Šä¸€é¡µ
        </button>
        <button class="tool-btn" id="next-page">
            <i class="bi bi-chevron-right"></i> ä¸‹ä¸€é¡µ
        </button>
        <button class="tool-btn" id="save-annotations">
            <i class="bi bi-save"></i> ä¿å­˜æ³¨é‡Š
        </button>
    </div>

    <div class="annotations-list">
        <h3>æ³¨é‡Šåˆ—è¡¨</h3>
        <div id="annotations-container"></div>

        <!-- OCRçŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="ocr-status-container" style="margin-top: 15px;">
            <h4>OCRçŠ¶æ€</h4>
            <div id="ocr-status" class="status-text">æ£€æŸ¥ä¸­...</div>
        </div>


    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script>
// è®¾ç½®PDF.js workerè·¯å¾„
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let pdfDoc = null;
let pageNum = 1;
let fabricCanvas = null;
let pdfCanvas = null;
let currentTool = 'select';
let annotations = [];

// åˆå§‹åŒ–å‡½æ•°
function initCanvas() {
    if (fabricCanvas) {
        fabricCanvas.dispose();
    }

    pdfCanvas = document.getElementById('pdf-canvas');
    const fabricCanvasEl = document.getElementById('fabric-canvas');

    fabricCanvas = new fabric.Canvas('fabric-canvas', {
        isDrawingMode: false,
        selection: true,
        backgroundColor: null,
        preserveObjectStacking: true,
        interactive: true
    });

    // ç¡®ä¿fabric canvasåœ¨æœ€ä¸Šå±‚å¹¶å¯ä»¥æ¥æ”¶äº‹ä»¶
    fabricCanvas.wrapperEl.style.zIndex = '2';

    // è®¾ç½®ç”»å¸ƒäº‹ä»¶ç›‘å¬å™¨
    setupCanvasEventListeners();

    // æ·»åŠ çª—å£å¤§å°æ”¹å˜äº‹ä»¶ç›‘å¬å™¨
    window.addEventListener('resize', debounce(() => {
        if (pdfDoc) {
            renderPage(pageNum);
        }
    }, 250));
}

// åˆå§‹åŒ–å·¥å…·æŒ‰é’®äº‹ä»¶
document.getElementById('rectangle-tool').addEventListener('click', () => {
    currentTool = 'rectangle';
    fabricCanvas.isDrawingMode = false;
    updateToolbarState();
});

document.getElementById('select-tool').addEventListener('click', () => {
    currentTool = 'select';
    fabricCanvas.isDrawingMode = false;
    updateToolbarState();
});

document.getElementById('prev-page').addEventListener('click', () => {
    if (pageNum <= 1) return;
    pageNum--;
    renderPage(pageNum);
});

document.getElementById('next-page').addEventListener('click', () => {
    if (pageNum >= pdfDoc.numPages) return;
    pageNum++;
    renderPage(pageNum);
});

document.getElementById('save-annotations').addEventListener('click', saveAnnotations);

// æ›´æ–°å·¥å…·æ çŠ¶æ€
function updateToolbarState() {
    document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    if (currentTool === 'rectangle') {
        document.getElementById('rectangle-tool').classList.add('active');
    } else if (currentTool === 'select') {
        document.getElementById('select-tool').classList.add('active');
    }
}

// æ–‡ä»¶ä¸Šä¼ ç›¸å…³åŠŸèƒ½
const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('pdf-upload');
const canvasContainer = document.getElementById('canvas-container');

uploadArea.addEventListener('click', () => {
    fileInput.click();
});

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file && file.type === 'application/pdf') {
        handleFileUpload(file);
    } else {
        showToast('è¯·ä¸Šä¼ PDFæ–‡ä»¶', 'error');
    }
});

fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        handleFileUpload(file);
    }
});

async function handleFileUpload(file) {
    try {
        showLoading();
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/upload_pdf', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error('ä¸Šä¼ å¤±è´¥');
        }

        const data = await response.json();
        uploadArea.style.display = 'none';
        canvasContainer.style.display = 'block';

        // ä¿å­˜PDFè·¯å¾„åˆ°å…¨å±€å˜é‡
        window.currentPdfPath = data.file_path;
        window.currentPdfUrl = data.file_url;

        // æ¸…ç©ºä¹‹å‰çš„æ³¨é‡Š
        annotations = [];

        // åˆå§‹åŒ–ç”»å¸ƒ
        initCanvas();

        // åŠ è½½æ–°ä¸Šä¼ çš„PDF
        await loadPDF(data.file_url);
        showToast('PDFæ–‡ä»¶ä¸Šä¼ æˆåŠŸ');

    } catch (error) {
        console.error('Upload error:', error);
        showToast('ä¸Šä¼ PDFæ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function loadPDF(url) {
    try {
        console.log('å¼€å§‹åŠ è½½PDF:', url);
        showLoading();

        // ç¡®ä¿URLæ˜¯ç»å¯¹è·¯å¾„å¹¶ä½¿ç”¨ä¸å½“å‰é¡µé¢ç›¸åŒçš„åè®®
        let absoluteUrl = url;
        if (!url.startsWith('http')) {
            absoluteUrl = window.location.origin + url;
        }
        
        // ç¡®ä¿ä½¿ç”¨ä¸å½“å‰é¡µé¢ç›¸åŒçš„åè®®(HTTPæˆ–HTTPS)
        const currentProtocol = window.location.protocol;
        if (absoluteUrl.startsWith('http:') && currentProtocol === 'https:') {
            absoluteUrl = absoluteUrl.replace('http:', 'https:');
            console.log('å·²å°†HTTPåè®®è½¬æ¢ä¸ºHTTPS:', absoluteUrl);
        }
        
        console.log('å¤„ç†åçš„PDF URL:', absoluteUrl);

        // å…ˆæ£€æŸ¥URLæ˜¯å¦å¯è®¿é—®
        console.log('å°è¯•è®¿é—®PDFæ–‡ä»¶...');
        const checkResponse = await fetch(absoluteUrl);
        if (!checkResponse.ok) {
            throw new Error(`PDFæ–‡ä»¶ä¸å¯è®¿é—®: ${checkResponse.status} ${checkResponse.statusText}`);
        }

        // è·å–æ–‡ä»¶å†…å®¹
        const pdfData = await checkResponse.arrayBuffer();
        console.log('PDFæ–‡ä»¶è·å–æˆåŠŸï¼Œå¤§å°:', pdfData.byteLength);

        const loadingTask = pdfjsLib.getDocument({data: pdfData});
        console.log('PDFåŠ è½½ä»»åŠ¡åˆ›å»ºæˆåŠŸ');

        pdfDoc = await loadingTask.promise;
        console.log('PDFåŠ è½½æˆåŠŸï¼Œæ€»é¡µæ•°:', pdfDoc.numPages);

        pageNum = 1;
        await renderPage(pageNum);

        // æ›´æ–°é¡µé¢å¯¼èˆªæŒ‰é’®çŠ¶æ€
        updatePageNavigation();
        hideLoading();
    } catch (error) {
        console.error('PDFåŠ è½½é”™è¯¯:', error);
        hideLoading();
        showToast(`åŠ è½½PDFæ–‡ä»¶å¤±è´¥: ${error.message}`, 'error');

        // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
        if (error.message.includes('Mixed Content')) {
            showToast('æ··åˆå†…å®¹é”™è¯¯: è¯·ç¡®ä¿ç½‘ç«™é€šè¿‡HTTPSè®¿é—®ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜é…ç½®æœåŠ¡å™¨ä»¥æ”¯æŒHTTPS', 'error');
        } else if (error.message.includes('Failed to fetch')) {
            showToast('ç½‘ç»œé”™è¯¯: æ— æ³•è·å–PDFæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜', 'error');
        }

        // æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
        uploadArea.style.display = 'block';
        canvasContainer.style.display = 'none';
    }
}

async function renderPage(num) {
    try {
        showLoading();
        const page = await pdfDoc.getPage(num);

        // é«˜æ¸…æ™°åº¦æ¸²æŸ“è®¾ç½®ï¼ˆæœ€ä¼˜åŒ–ç‰ˆï¼‰
        const container = document.querySelector('#canvas-container');

        // è·å–å¯ç”¨çš„æ˜¾ç¤ºåŒºåŸŸ
        const availableWidth = Math.min(
            container.clientWidth - 40, // å‡å»padding
            window.innerWidth - 320     // å‡å»ä¾§è¾¹æ å’Œå·¥å…·æ 
        );
        const availableHeight = Math.min(
            container.clientHeight - 40, // å‡å»padding
            window.innerHeight - 200     // å‡å»å¤´éƒ¨å’Œåº•éƒ¨
        );

        // è®¡ç®—é€‚åˆå®¹å™¨çš„åŸºç¡€ç¼©æ”¾æ¯”ä¾‹
        const pageViewport = page.getViewport({ scale: 1 });
        const scaleX = availableWidth / pageViewport.width;
        const scaleY = availableHeight / pageViewport.height;
        const baseScale = Math.min(scaleX, scaleY);

        // æ˜¾ç¤ºç¼©æ”¾ï¼ˆç”¨æˆ·çœ‹åˆ°çš„å¤§å°ï¼‰- å°½å¯èƒ½å¤§ä½†ç¡®ä¿å®Œæ•´æ˜¾ç¤º
        const displayScale = Math.max(0.5, baseScale * 0.85); // è‡³å°‘0.5å€ï¼Œæœ€å¤š85%å¯ç”¨ç©ºé—´

        // æé«˜æ¸²æŸ“è´¨é‡ï¼šä½¿ç”¨æ›´é«˜çš„å†…éƒ¨æ¸²æŸ“åˆ†è¾¨ç‡
        const devicePixelRatio = window.devicePixelRatio || 1;
        const qualityMultiplier = 2.0; // é™ä½åˆ°2.0é¿å…è¿‡å¤§
        const renderScale = displayScale * devicePixelRatio * qualityMultiplier;

        // æ¸²æŸ“viewportï¼ˆé«˜åˆ†è¾¨ç‡ï¼Œç”¨äºå†…éƒ¨æ¸²æŸ“ï¼‰
        const renderViewport = page.getViewport({ scale: renderScale });
        // æ˜¾ç¤ºviewportï¼ˆç”¨æˆ·ç•Œé¢å¤§å°ï¼Œç¡®ä¿å®Œæ•´æ˜¾ç¤ºï¼‰
        const displayViewport = page.getViewport({ scale: displayScale });

        // è®¾ç½®canvasçš„å®é™…æ¸²æŸ“å°ºå¯¸ï¼ˆé«˜åˆ†è¾¨ç‡ï¼‰
        pdfCanvas.width = renderViewport.width;
        pdfCanvas.height = renderViewport.height;

        // è®¾ç½®canvasçš„æ˜¾ç¤ºå°ºå¯¸ï¼ˆç”¨æˆ·ç•Œé¢å¤§å°ï¼‰
        pdfCanvas.style.width = `${displayViewport.width}px`;
        pdfCanvas.style.height = `${displayViewport.height}px`;

        // è®¾ç½®fabric canvaså°ºå¯¸ï¼ˆä¸æ˜¾ç¤ºå°ºå¯¸ä¸€è‡´ï¼‰
        fabricCanvas.setWidth(displayViewport.width);
        fabricCanvas.setHeight(displayViewport.height);

        // è®¾ç½®canvas-wrapperå°ºå¯¸ï¼ˆç¡®ä¿å®¹å™¨èƒ½å®¹çº³å®Œæ•´å†…å®¹ï¼‰
        const wrapper = document.querySelector('.canvas-wrapper');
        wrapper.style.width = `${displayViewport.width}px`;
        wrapper.style.height = `${displayViewport.height}px`;

        // è·å–é«˜åˆ†è¾¨ç‡æ¸²æŸ“ä¸Šä¸‹æ–‡
        const ctx = pdfCanvas.getContext('2d');

        // æ¸…é™¤ä¹‹å‰çš„å˜æ¢
        ctx.setTransform(1, 0, 0, 1, 0, 0);

        // è®¾ç½®é«˜è´¨é‡æ¸²æŸ“é€‰é¡¹
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';

        // æ¸²æŸ“PDFé¡µé¢åˆ°pdfCanvasï¼ˆé«˜åˆ†è¾¨ç‡ï¼‰
        const renderContext = {
            canvasContext: ctx,
            viewport: renderViewport,
            // æ·»åŠ æ¸²æŸ“é€‰é¡¹ä»¥æé«˜è´¨é‡
            intent: 'display',
            renderInteractiveForms: false
        };

        await page.render(renderContext).promise;
        console.log(`é¡µé¢æ¸²æŸ“å®Œæˆ:`);
        console.log(`- å¯ç”¨åŒºåŸŸ: ${availableWidth}x${availableHeight}`);
        console.log(`- PDFåŸå§‹å°ºå¯¸: ${pageViewport.width}x${pageViewport.height}`);
        console.log(`- åŸºç¡€ç¼©æ”¾: ${baseScale.toFixed(3)}`);
        console.log(`- æ˜¾ç¤ºç¼©æ”¾: ${displayScale.toFixed(3)}`);
        console.log(`- æ¸²æŸ“åˆ†è¾¨ç‡: ${renderViewport.width}x${renderViewport.height}`);
        console.log(`- æ˜¾ç¤ºåˆ†è¾¨ç‡: ${displayViewport.width}x${displayViewport.height}`);

        // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
        fabricCanvas.clear();

        // åŠ è½½è¯¥é¡µé¢çš„æ³¨é‡Š
        loadPageAnnotations(num);

        // æ›´æ–°é¡µé¢å¯¼èˆªçŠ¶æ€
        updatePageNavigation();
        hideLoading();
    } catch (error) {
        console.error('Error rendering page:', error);
        hideLoading();
        showToast('æ¸²æŸ“é¡µé¢å¤±è´¥: ' + error.message, 'error');
    }
}

// è®¾ç½®ç”»å¸ƒäº‹ä»¶ç›‘å¬å™¨
function setupCanvasEventListeners() {
    let isDrawing = false;
    let startX, startY;
    let rect;

    fabricCanvas.on('mouse:down', function(options) {
        if (currentTool !== 'rectangle') return;

        isDrawing = true;
        const pointer = fabricCanvas.getPointer(options.e);
        startX = pointer.x;
        startY = pointer.y;

        rect = new fabric.Rect({
            left: startX,
            top: startY,
            width: 0,
            height: 0,
            fill: 'rgba(255, 255, 0, 0.3)',
            stroke: '#FFD700',
            strokeWidth: 2,
            selectable: true,
            evented: true
        });

        fabricCanvas.add(rect);
        fabricCanvas.renderAll();
    });

    fabricCanvas.on('mouse:move', function(options) {
        if (!isDrawing) return;

        const pointer = fabricCanvas.getPointer(options.e);
        const width = pointer.x - startX;
        const height = pointer.y - startY;

        rect.set({
            width: width,
            height: height
        });

        fabricCanvas.renderAll();
    });

    fabricCanvas.on('mouse:up', async function() {
        if (!isDrawing) return;
        isDrawing = false;

        if (rect.width < 10 || rect.height < 10) {
            fabricCanvas.remove(rect);
            fabricCanvas.renderAll();
            return;
        }

        try {
            // è·å–æ ‡æ³¨åŒºåŸŸçš„å›¾åƒæ•°æ®
            const imageData = await getRegionImageData(rect);

            // å‘é€åˆ°åç«¯è¿›è¡ŒOCRè¯†åˆ«
            const response = await fetch('/ocr_region', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    imageData: imageData
                })
            });

            if (!response.ok) {
                throw new Error('OCRè¯·æ±‚å¤±è´¥');
            }

            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || 'OCRè¯†åˆ«å¤±è´¥');
            }

            // åˆ›å»ºæ³¨é‡Šå¯¹è±¡
            const annotation = {
                type: 'rectangle',
                page: pageNum,
                coords: {
                    left: rect.left,
                    top: rect.top,
                    width: rect.width,
                    height: rect.height
                },
                text: result.text,
                ocrResult: result.text,  // ä¿å­˜OCRè¯†åˆ«ç»“æœ
                confidence: result.confidence || 0,  // ä¿å­˜ç½®ä¿¡åº¦
                details: result.details || []  // ä¿å­˜è¯¦ç»†è¯†åˆ«ç»“æœ
            };

            annotations.push(annotation);
            updateAnnotationsList();

            // æ˜¾ç¤ºæ›´è¯¦ç»†çš„æˆåŠŸä¿¡æ¯
            const confidenceText = result.confidence ? ` (ç½®ä¿¡åº¦: ${(result.confidence * 100).toFixed(1)}%)` : '';
            showToast(`EasyOCRè¯†åˆ«å®Œæˆ${confidenceText}`);

        } catch (error) {
            console.error('OCR error:', error);
            showToast('OCRè¯†åˆ«å¤±è´¥: ' + error.message, 'error');
            fabricCanvas.remove(rect);
        }

        fabricCanvas.renderAll();
    });
}

// è·å–æ ‡æ³¨åŒºåŸŸçš„å›¾åƒæ•°æ®ï¼ˆä¿®å¤ç‰ˆé«˜åˆ†è¾¨ç‡ï¼‰
async function getRegionImageData(rect) {
    // åˆ›å»ºä¸€ä¸ªæ–°çš„canvasæ¥è·å–åŒºåŸŸå›¾åƒ
    const tempCanvas = document.createElement('canvas');
    const ctx = tempCanvas.getContext('2d');

    // è®¡ç®—é«˜åˆ†è¾¨ç‡ç¼©æ”¾æ¯”ä¾‹ï¼ˆä¸æ¸²æŸ“æ—¶ä¿æŒä¸€è‡´ï¼‰
    const devicePixelRatio = window.devicePixelRatio || 1;
    const qualityMultiplier = 2.0; // ä¸æ¸²æŸ“æ—¶ä½¿ç”¨çš„ç›¸åŒå€æ•°
    const totalScale = devicePixelRatio * qualityMultiplier;

    // è®¡ç®—åœ¨é«˜åˆ†è¾¨ç‡canvasä¸Šçš„å®é™…åæ ‡
    const actualLeft = rect.left * totalScale;
    const actualTop = rect.top * totalScale;
    const actualWidth = Math.abs(rect.width * totalScale);
    const actualHeight = Math.abs(rect.height * totalScale);

    // è®¾ç½®ä¸´æ—¶canvasä¸ºé«˜åˆ†è¾¨ç‡å¤§å°
    tempCanvas.width = actualWidth;
    tempCanvas.height = actualHeight;

    // è®¾ç½®é«˜è´¨é‡æ¸²æŸ“é€‰é¡¹
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';

    try {
        // ä»é«˜åˆ†è¾¨ç‡PDF canvaså¤åˆ¶åŒºåŸŸå›¾åƒ
        ctx.drawImage(
            pdfCanvas,
            actualLeft,
            actualTop,
            actualWidth,
            actualHeight,
            0,
            0,
            actualWidth,
            actualHeight
        );
    } catch (error) {
        console.warn('é«˜åˆ†è¾¨ç‡å›¾åƒæå–å¤±è´¥ï¼Œä½¿ç”¨æ ‡å‡†åˆ†è¾¨ç‡:', error);

        // é™çº§åˆ°æ ‡å‡†åˆ†è¾¨ç‡æå–
        tempCanvas.width = Math.abs(rect.width);
        tempCanvas.height = Math.abs(rect.height);

        ctx.drawImage(
            pdfCanvas,
            rect.left,
            rect.top,
            rect.width,
            rect.height,
            0,
            0,
            rect.width,
            rect.height
        );
    }

    // è¿”å›é«˜è´¨é‡çš„base64æ ¼å¼å›¾åƒæ•°æ®
    return tempCanvas.toDataURL('image/png', 0.95); // ä½¿ç”¨é«˜è´¨é‡PNG
}

// æ›´æ–°æ³¨é‡Šåˆ—è¡¨
function updateAnnotationsList() {
    const container = document.getElementById('annotations-container');
    container.innerHTML = '';

    const pageAnnotations = annotations.filter(a => a.page === pageNum);

    pageAnnotations.forEach((annotation, index) => {
        const div = document.createElement('div');
        div.className = 'annotation-item';

        // æ„å»ºç½®ä¿¡åº¦æ˜¾ç¤º
        const confidenceText = annotation.confidence ?
            ` <span style="color: #666; font-size: 0.8em;">(${(annotation.confidence * 100).toFixed(1)}%)</span>` : '';

        // è·å–å…¨å±€ç´¢å¼•
        const globalIndex = annotations.indexOf(annotation);

        div.innerHTML = `
            <div class="annotation-content">
                <div class="annotation-text" id="text-${globalIndex}">${annotation.ocrResult || 'æ— è¯†åˆ«æ–‡æœ¬'}${confidenceText}</div>
                <div class="annotation-page">ç¬¬ ${annotation.page} é¡µ</div>
            </div>
            <div class="annotation-actions">
                <button class="btn-edit" onclick="editAnnotation(${globalIndex})" title="ç¼–è¾‘">âœï¸</button>
                <button class="btn-delete" onclick="deleteAnnotation(${globalIndex})" title="åˆ é™¤">ğŸ—‘ï¸</button>
            </div>
        `;

        // ç‚¹å‡»æ³¨é‡Šå†…å®¹åŒºåŸŸé«˜äº®æ˜¾ç¤º
        div.querySelector('.annotation-content').onclick = () => highlightAnnotation(index);
        container.appendChild(div);
    });
}

// ç¼–è¾‘æ³¨é‡Š
function editAnnotation(globalIndex) {
    const annotation = annotations[globalIndex];
    if (!annotation) return;

    const newText = prompt('ç¼–è¾‘æ³¨é‡Šæ–‡æœ¬:', annotation.ocrResult || annotation.text || '');
    if (newText !== null && newText.trim() !== '') {
        // æ›´æ–°æ³¨é‡Šæ–‡æœ¬
        annotation.text = newText.trim();
        annotation.ocrResult = newText.trim();

        // æ›´æ–°æ˜¾ç¤º
        updateAnnotationsList();

        // å¦‚æœå½“å‰é¡µé¢åŒ…å«è¿™ä¸ªæ³¨é‡Šï¼Œé‡æ–°åŠ è½½é¡µé¢æ³¨é‡Š
        if (annotation.page === pageNum) {
            loadPageAnnotations(pageNum);
        }

        showToast('æ³¨é‡Šå·²æ›´æ–°');
    }
}

// åˆ é™¤æ³¨é‡Š
function deleteAnnotation(globalIndex) {
    const annotation = annotations[globalIndex];
    if (!annotation) return;

    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ³¨é‡Šå—ï¼Ÿ')) {
        // ä»æ•°ç»„ä¸­ç§»é™¤æ³¨é‡Š
        annotations.splice(globalIndex, 1);

        // æ›´æ–°æ˜¾ç¤º
        updateAnnotationsList();

        // å¦‚æœå½“å‰é¡µé¢åŒ…å«è¿™ä¸ªæ³¨é‡Šï¼Œé‡æ–°åŠ è½½é¡µé¢æ³¨é‡Š
        if (annotation.page === pageNum) {
            loadPageAnnotations(pageNum);
        }

        showToast('æ³¨é‡Šå·²åˆ é™¤');
    }
}

// é«˜äº®æ˜¾ç¤ºé€‰ä¸­çš„æ³¨é‡Š
function highlightAnnotation(index) {
    const pageAnnotations = annotations.filter(a => a.page === pageNum);
    const annotation = pageAnnotations[index];

    if (!annotation) return;

    if (annotation.page !== pageNum) {
        pageNum = annotation.page;
        renderPage(pageNum);
    }

    // æ‰¾åˆ°å¯¹åº”çš„çŸ©å½¢å¯¹è±¡å¹¶é€‰ä¸­å®ƒ
    fabricCanvas.getObjects().forEach(obj => {
        if (obj.left === annotation.coords.left &&
            obj.top === annotation.coords.top) {
            fabricCanvas.setActiveObject(obj);
            fabricCanvas.renderAll();
        }
    });
}

// ä¿å­˜æ³¨é‡Š
async function saveAnnotations() {
    try {
        const response = await fetch('/save_annotations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                annotations: annotations
            })
        });

        if (response.ok) {
            showToast('æ³¨é‡Šä¿å­˜æˆåŠŸ');
        } else {
            throw new Error('ä¿å­˜å¤±è´¥');
        }
    } catch (error) {
        console.error('Error saving annotations:', error);
        showToast('ä¿å­˜æ³¨é‡Šå¤±è´¥', 'error');
    }
}

// åŠ è½½é¡µé¢æ³¨é‡Š
function loadPageAnnotations(pageNum) {
    fabricCanvas.clear();

    const pageAnnotations = annotations.filter(a => a.page === pageNum);
    pageAnnotations.forEach(annotation => {
        const rect = new fabric.Rect({
            left: annotation.coords.left,
            top: annotation.coords.top,
            width: annotation.coords.width,
            height: annotation.coords.height,
            fill: 'rgba(255, 255, 0, 0.3)',
            stroke: '#FFD700',
            strokeWidth: 2
        });
        fabricCanvas.add(rect);
    });

    updateAnnotationsList();
}







// è·å–å½“å‰PDFè·¯å¾„
function getCurrentPdfPath() {
    // ä»ä¸Šä¼ æ—¶ä¿å­˜çš„ä¿¡æ¯ä¸­è·å–PDFè·¯å¾„
    return window.currentPdfPath || null;
}

// ä»URLæå–æ–‡ä»¶è·¯å¾„
function extractPathFromUrl(url) {
    try {
        // ä»URLä¸­æå–æ–‡ä»¶å
        const urlParts = url.split('/');
        const filename = urlParts[urlParts.length - 1];

        // æ„å»ºæœåŠ¡å™¨ç«¯æ–‡ä»¶è·¯å¾„
        // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„æœåŠ¡å™¨ç«¯è·¯å¾„ç»“æ„æ¥è°ƒæ•´
        return `/uploads/${getCurrentUsername()}_pdfs/${filename}`;
    } catch (error) {
        console.error('Error extracting path from URL:', error);
        return null;
    }
}

// è·å–å½“å‰ç”¨æˆ·å
function getCurrentUsername() {
    // ä»Flaskæ¨¡æ¿å˜é‡è·å–ç”¨æˆ·å
    return '{{ current_user.username if current_user.is_authenticated else "anonymous" }}';
}

function showLoading() {
    document.querySelector('.loading-overlay').style.display = 'flex';
}

function hideLoading() {
    document.querySelector('.loading-overlay').style.display = 'none';
}

// æ·»åŠ é¡µé¢å¯¼èˆªçŠ¶æ€æ›´æ–°å‡½æ•°
function updatePageNavigation() {
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');

    prevBtn.disabled = pageNum <= 1;
    nextBtn.disabled = pageNum >= pdfDoc.numPages;
}

// æ·»åŠ é˜²æŠ–å‡½æ•°
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// æ£€æŸ¥OCRçŠ¶æ€
async function checkOCRStatus() {
    try {
        const response = await fetch('/ocr_status');
        if (!response.ok) {
            throw new Error('è·å–OCRçŠ¶æ€å¤±è´¥');
        }

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || 'OCRçŠ¶æ€æ£€æŸ¥å¤±è´¥');
        }

        const ocrInfo = result.ocr_info;
        const statusElement = document.getElementById('ocr-status');

        if (ocrInfo.status === 'ready') {
            const languages = Array.isArray(ocrInfo.languages) ? ocrInfo.languages.join(', ') : ocrInfo.languages;
            const gpuText = ocrInfo.gpu_enabled ? ' (GPUåŠ é€Ÿ)' : ' (CPUæ¨¡å¼)';
            statusElement.innerHTML = `âœ… EasyOCRå°±ç»ª - æ”¯æŒè¯­è¨€: ${languages}${gpuText}`;
            statusElement.style.color = '#1a1a1a'; /* æ·±é»‘è‰²ï¼Œç¡®ä¿é«˜å¯¹æ¯”åº¦ */
            statusElement.style.fontWeight = '600'; /* åŠ ç²—å­—ä½“ */
        } else if (ocrInfo.status === 'not_initialized') {
            statusElement.innerHTML = 'â³ EasyOCRåˆå§‹åŒ–ä¸­...';
            statusElement.style.color = '#1a1a1a'; /* æ·±é»‘è‰²ï¼Œç¡®ä¿é«˜å¯¹æ¯”åº¦ */
            statusElement.style.fontWeight = '600'; /* åŠ ç²—å­—ä½“ */
            // 5ç§’åé‡æ–°æ£€æŸ¥
            setTimeout(checkOCRStatus, 5000);
        } else {
            statusElement.innerHTML = `âŒ EasyOCRé”™è¯¯: ${ocrInfo.error || 'æœªçŸ¥é”™è¯¯'}`;
            statusElement.style.color = '#1a1a1a'; /* æ·±é»‘è‰²ï¼Œç¡®ä¿é«˜å¯¹æ¯”åº¦ */
            statusElement.style.fontWeight = '600'; /* åŠ ç²—å­—ä½“ */
        }

    } catch (error) {
        console.error('OCR status check error:', error);
        const statusElement = document.getElementById('ocr-status');
        statusElement.innerHTML = `âŒ æ— æ³•è·å–OCRçŠ¶æ€: ${error.message}`;
        statusElement.style.color = '#1a1a1a'; /* æ·±é»‘è‰²ï¼Œç¡®ä¿é«˜å¯¹æ¯”åº¦ */
        statusElement.style.fontWeight = '600'; /* åŠ ç²—å­—ä½“ */
    }
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥OCRçŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    checkOCRStatus();
});

// åˆå§‹åŒ–æ—¶åŠ è½½ç¤ºä¾‹PDFï¼ˆå®é™…ä½¿ç”¨æ—¶åº”è¯¥é€šè¿‡ä¸Šä¼ æˆ–é€‰æ‹©æ–‡ä»¶æ¥åŠ è½½ï¼‰
// loadPDF('/path/to/sample.pdf');
</script>
{% endblock %}